services:
  wordpress:
    image: wordpress:latest
    ports:
      - "8080:80"
    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
      WORDPRESS_CONFIG_EXTRA: |
        define('FS_METHOD', 'direct');
    volumes:
      - wp_content:/var/www/html/wp-content
    depends_on:
      - db
    networks:
      - wpnet

  theme_sync:
    image: alpine/git:2.45.2
    restart: unless-stopped

    # IMPORTANTE para Dokploy: anular entrypoint de la imagen
    entrypoint: []

    environment:
      MAUSWP_GIT_URL: ${MAUSWP_GIT_URL}
      SYNC_INTERVAL: "300"

    volumes:
      - wp_content:/data

    # Command en formato array (Dokploy-safe)
    command:
      - "sh"
      - "-lc"
      - >
        set -eu;
        echo "== theme_sync arrancando ==";
        mkdir -p /data/plugins /data/themes /data/uploads /data/mu-plugins /data/languages /data/upgrade;
        if [ -z "${MAUSWP_GIT_URL:-}" ]; then
          echo "ERROR: MAUSWP_GIT_URL no est√° definida";
          exit 1;
        fi;
        sync_once() {
          echo "== Clonando repo ==";
          rm -rf /tmp/repo;
          git clone --depth 1 --branch main "${MAUSWP_GIT_URL}" /tmp/repo;

          if [ ! -f "/tmp/repo/wp-content/themes/mauswp/style.css" ]; then
            echo "ERROR: No existe wp-content/themes/mauswp/style.css en el repo";
            echo "DEBUG: contenido real:";
            ls -la /tmp/repo/wp-content/themes || true;
            exit 1;
          fi;

          echo "== Copiando theme ==";
          rm -rf /tmp/theme.new;
          mkdir -p /tmp/theme.new;
          cp -a /tmp/repo/wp-content/themes/mauswp/. /tmp/theme.new/;

          chown -R 33:33 /tmp/theme.new || true;

          rm -rf /data/themes/mauswp.bak;
          if [ -d /data/themes/mauswp ]; then
            mv /data/themes/mauswp /data/themes/mauswp.bak;
          fi;

          mv /tmp/theme.new /data/themes/mauswp;
          rm -rf /data/themes/mauswp.bak;

          chown -R 33:33 /data || true;

          echo "OK: mauswp sincronizado correctamente";
        };
        sync_once;
        while true; do
          sleep "${SYNC_INTERVAL}";
          sync_once || true;
        done

    depends_on:
      - wordpress
    networks:
      - wpnet

  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
      MYSQL_USER: ${WORDPRESS_DB_USER}
      MYSQL_PASSWORD: ${WORDPRESS_DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - wpnet

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    depends_on:
      - db
    ports:
      - "8081:80"
    environment:
      PMA_HOST: db
      PMA_USER: ${WORDPRESS_DB_USER}
      PMA_PASSWORD: ${WORDPRESS_DB_PASSWORD}
    networks:
      - wpnet

volumes:
  db_data:
  wp_content:

networks:
  wpnet:
